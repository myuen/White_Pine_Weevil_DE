---
output: html_document
---
<!---
Create an interactive heatmap with bubble containing information of contig ID, expression value in CPM and annotation when mouse-over.
-->


```{r, echo=FALSE, message=FALSE}
library(d3heatmap)
library(htmlwidgets)
library(plyr)

source("helper02_load-exp-des.r")
source("helper03_load-focus-statinf.r")


# abs(logFC) log fold change cut-off.  Anything greater than (-1 x lfc) and less 
# than lfc will be deemed biological insignificant
lfcCutoff <- 2

# p-value cut-off.  Anything > pCutoff will be deemed statistically insignificant.
pCutoff <- 0.01


cpmCounts <- read.table("../results/normalized_cpm.15July.txt")


expDes <- load_expDes()
expDes$grp <-
  with(expDes, factor(grp,
                      levels = paste(levels(gType),
                                     rep(levels(tx), each = 2), sep = ".")))

avgCPM <- ddply(expDes, ~grp, function(x) {
  df <- rowMeans(cpmCounts[, c(expDes[expDes$grp == x$grp,]$sample)])
  return(df)
})

colnames(avgCPM) <- 
  gsub("WPW_Inoculation_Trinity_BBMerged_31May2016_TRINITY_", "", colnames(avgCPM))
n <- avgCPM$grp
avgCPM <- as.data.frame(t(avgCPM[,-1]))
colnames(avgCPM) <- n


sidf <- load_focus_statInf()
sidf$cds <- 
  as.character(gsub("WPW_Inoculation_Trinity_BBMerged_31May2016_TRINITY_", "", sidf$cds))


annots <- read.delim(
  "../results/WPW_Inoculation_Trinity_BBMerged_31May2016.transdecoder.cds.nr.diffExp.blastxNR.collapsed.txt", row.names = 1)
row.names(annots) <- 
  gsub("WPW_Inoculation_Trinity_BBMerged_31May2016_TRINITY_", "", row.names(annots))
annots$annot <- as.character(annots$annot)


# Weevil Induce Q903 (Q903G - Q903W)
weevilInd_q903 <- subset(sidf, sidf$focus_term == "weevilInd_Q903" & 
                            sidf$adj.P.Val <= pCutoff & abs(sidf$logFC) >= lfcCutoff)

# Subset weevilInd_Q903 DE contigs from avgCPM
weevilInd_q903_avgCPM <- avgCPM[rownames(avgCPM) %in% weevilInd_q903$cds,]


# Create cellnote when mouse hover over
weevilInd_q903_cellnote <- weevilInd_q903_avgCPM


for (i in 1:6) {
  weevilInd_q903_cellnote[, i] <-
    paste("CPM : ", weevilInd_q903_cellnote[, i], "\n",
          "Annot : ", annots[rownames(weevilInd_q903_cellnote), "annot"])
}


weevilInd_q903_row_dist <- as.dist(1 - cor(t(weevilInd_q903_avgCPM), method = "spearman"))
weevilInd_q903_row_hclust <- hclust(weevilInd_q903_row_dist, method = "average")
weevilInd_q903_row_dendrogram <- as.dendrogram(weevilInd_q903_row_hclust)

weevilInd_q903_col_dist <- as.dist(1 - cor(weevilInd_q903_avgCPM, method = "spearman"))
weevilInd_q903_col_hclust <- hclust(weevilInd_q903_col_dist, method = "average")
weevilInd_q903_col_dendrogram <- as.dendrogram(weevilInd_q903_col_hclust)


d3heatmap(as.matrix(weevilInd_q903_avgCPM),
                               colors = heat.colors(50),
                               scale = "row",
                               Rowv = weevilInd_q903_row_dendrogram,
                               Colv = weevilInd_q903_col_dendrogram,
                               width = 1000, height = 8000,
                               cexCol = 0.65, cexRow = 0.65,
                               cellnote = weevilInd_q903_cellnote,
                               anim_duration = 0)

```
