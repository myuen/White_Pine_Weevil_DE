<!---
Create an interactive heatmap with bubble containing information of contig ID, expression value in CPM and annotation when mouse-over.
-->


```{r, echo=FALSE, message=FALSE}
library(vegan)
library(htmlwidgets)
library(d3heatmap)

source("helper02_load-exp-des.r")
source("helper03_load-focus-statinf.r")


# abs(logFC) log fold change cut-off.  Anything greater than (-1 x lfc) and less 
# than lfc will be deemed biological insignificant
lfcCutoff <- 2

# p-value cut-off.  Anything > pCutoff will be deemed statistically insignificant.
pCutoff <- 0.01


cpmCounts <- read.table("../results/normalized_cpm.txt")


expDes <- load_expDes()
expDes$grp <-
  with(expDes, factor(grp,
                      levels = paste(levels(gType),
                                     rep(levels(tx), each = 2), sep = ".")))

avgCPM <- ddply(expDes, ~grp, function(x) {
  df <- rowMeans(cpmCounts[,c(expDes[expDes$grp == x$grp,]$sample)])
  return(df)
})

avgCPM <- data.frame(avgCPM, row.names = avgCPM$grp)
avgCPM <- avgCPM[, -1]
avgCPM <- t(avgCPM)


row.names(avgCPM) <- gsub("WPW_Inoculation_Trinity_C500_", "", row.names(avgCPM))


sidf <- load_focus_statInf()
sidf$contig <- as.character(gsub("WPW_Inoculation_Trinity_C500_", "", sidf$contig))


annots <- read.delim(
  "../results/WPW_Inoculation_Trinity_C500.diffExp.lfc2.blastxNr.collapsed.txt", 
  row.names = 1)
row.names(annots) <- gsub("WPW_Inoculation_Trinity_C500_", "", row.names(annots))
annots$annot <- as.character(annots$annot)


# Constitutive Control (H898C - Q903C)
constDiff <- (subset(sidf, sidf$focus_term == "constDiff" & 
                       sidf$adj.P.Val <= pCutoff & abs(sidf$logFC) >= lfcCutoff))

# Subset constitutive DE contigs from avgCPM
constDiff_avgCPM <- avgCPM[rownames(avgCPM) %in% constDiff$contig,]


# Create cellnote when mouse hover over
constDiff_cellnote <- constDiff_avgCPM


for (i in 1:6) {
  constDiff_cellnote[, i] <-
    paste("CPM : ", constDiff_cellnote[, i], "\n",
          "Annot : ", annots[rownames(constDiff_cellnote), "annot"])
}


constDiff_row_dist <- vegdist(constDiff_avgCPM, method = "horn")
constDiff_row_hclust <- hclust(constDiff_row_dist, "average")
constDiff_row_dendrogram <- as.dendrogram(constDiff_row_hclust)


constDiff_col_dist <- vegdist(t(constDiff_avgCPM), method = "horn")
constDiff_col_hclust <- hclust(constDiff_col_dist, "average")
constDiff_col_dendrogram <- as.dendrogram(constDiff_col_hclust)


d3heatmap(as.matrix(constDiff_avgCPM),
                               colors = heat.colors(50),
                               scale = "row",
                               Rowv = constDiff_row_dendrogram,
                               Colv = constDiff_col_dendrogram,
                               width = 1000, height = 8000,
                               cexCol = 0.65, cexRow = 0.65,
                               cellnote = constDiff_cellnote,
                               anim_duration = 0)

```
