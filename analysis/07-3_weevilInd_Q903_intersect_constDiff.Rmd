<!---
Create an interactive heatmap with bubble containing information of contig ID, expression value in CPM and annotation when mouse-over.
-->


```{r, echo=FALSE, message=FALSE}
library(vegan)
library(htmlwidgets)
library(d3heatmap)

source("helper02_load-exp-des.r")
source("helper03_load-focus-statinf.r")


# abs(logFC) log fold change cut-off.  Anything greater than (-1 x lfc) and less 
# than lfc will be deemed biological insignificant
lfcCutoff <- 2

# p-value cut-off.  Anything > pCutoff will be deemed statistically insignificant.
pCutoff <- 0.01


cpmCounts <- read.table("../results/normalized_cpm.txt")


expDes <- load_expDes()
expDes$grp <-
  with(expDes, factor(grp,
                      levels = paste(levels(gType),
                                     rep(levels(tx), each = 2), sep = ".")))

avgCPM <- ddply(expDes, ~grp, function(x) {
  df <- rowMeans(cpmCounts[,c(expDes[expDes$grp == x$grp,]$sample)])
  return(df)
})

avgCPM <- data.frame(avgCPM, row.names = avgCPM$grp)
avgCPM <- avgCPM[, -1]
avgCPM <- t(avgCPM)


row.names(avgCPM) <- gsub("WPW_Inoculation_Trinity_C500_", "", row.names(avgCPM))


sidf.wide <- read.table("../results/limma-results-focus-terms.wide.tsv")
row.names(sidf.wide) <- as.character(gsub("WPW_Inoculation_Trinity_C500_", "",
                                          row.names(sidf.wide)))


annots <- read.delim(
  "../results/WPW_Inoculation_Trinity_C500.diffExp.lfc2.blastxNr.collapsed.txt", 
  row.names = 1)
row.names(annots) <- gsub("WPW_Inoculation_Trinity_C500_", "", row.names(annots))
annots$annot <- as.character(annots$annot)


# Constitutive Control (H898C - Q903C)
intersection <- subset(sidf.wide, 
                       sidf.wide$adj.P.Val.constDiff <= pCutoff & 
                         sidf.wide$adj.P.Val.weevilInd_Q903 <= pCutoff & 
                         abs(sidf.wide$logFC.constDiff) >= lfcCutoff &
                         abs(sidf.wide$logFC.weevilInd_Q903) >= lfcCutoff)


# Subset constitutive DE contigs from avgCPM
intersection_avgCPM <- avgCPM[rownames(intersection),]


# Create cellnote when mouse hover over
intersection_cellnote <- intersection_avgCPM


for (i in 1:6) {
  intersection_cellnote[, i] <-
    paste("CPM : ", intersection_cellnote[, i], "\n",
          "Annot : ", annots[rownames(intersection_cellnote), "annot"])
}


intersection_row_dist <- vegdist(intersection_avgCPM, method = "horn")
intersection_row_hclust <- hclust(intersection_row_dist, "average")
intersection_row_dendrogram <- as.dendrogram(intersection_row_hclust)


intersection_col_dist <- vegdist(t(intersection_avgCPM), method = "horn")
intersection_col_hclust <- hclust(intersection_col_dist, "average")
intersection_col_dendrogram <- as.dendrogram(intersection_col_hclust)


d3heatmap(as.matrix(intersection_avgCPM),
                               colors = heat.colors(50),
                               scale = "row",
                               Rowv = intersection_row_dendrogram,
                               Colv = intersection_col_dendrogram,
                               cexCol = 0.65, cexRow = 0.65,
                               width = 900, height = 1600,
                               cellnote = intersection_cellnote,
                               anim_duration = 0)

```
