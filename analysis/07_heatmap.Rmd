<!---
Create an interactive heatmap with bubble containing information of contig ID, expression value in CPM and annotation when mouse-over.
-->


```{r, echo=FALSE, message=FALSE}
library(edgeR)
library(vegan)
library(htmlwidgets)
library(d3heatmap)

source("helper02_load-exp-des.r")
source("helper03_load-focus-statinf.r")


# abs(logFC) log fold change cut-off.  Anything greater than (-1 x lfc) and less 
# than lfc will be deemed biological insignificant
lfcCutoff <- 2

# p-value cut-off.  Anything > pCutoff will be deemed statistically insignificant.
pCutoff <- 0.01


rawSailfishCounts <- read.delim("../data/consolidated-Sailfish-results.txt")
# str(rawSailfishCounts) # 'data.frame':  483047 obs. of  24 variables:


expDes <- load_expDes()
expDes$grp <- # not really sure that we need this?
  with(expDes, factor(grp,
                      levels = paste(levels(gType),
                                     rep(levels(tx), each = 2), sep = ".")))
# str(expDes) # 'data.frame':  24 obs. of  6 variables


cpmCounts <- cpm(rawSailfishCounts)
# str(cpmCounts)

avgCPM <- ddply(expDes, ~grp, function(x) {
  df <- rowMeans(cpmCounts[,c(expDes[expDes$grp == x$grp,]$sample)])
  return(df)
})

avgCPM <- data.frame(avgCPM, row.names = avgCPM$grp)
avgCPM <- avgCPM[, -1]
avgCPM <- t(avgCPM)


row.names(avgCPM) <- gsub("WPW_Inoculation_Trinity_C500_", "", row.names(avgCPM))
# str(avgCPM) #483047 obs. of  6 variables


sidf <- load_focus_statInf()
sidf$contig <- as.character(gsub("WPW_Inoculation_Trinity_C500_", "", sidf$contig))
# str(sidf) # 406728 obs.


annots <- read.delim(
  "../results/WPW_Inoculation_Trinity_C500.diffExp.lfc2.blastxNr.collapsed.txt", 
  row.names = 1)
row.names(annots) <- gsub("WPW_Inoculation_Trinity_C500_", "", row.names(annots))
annots$annot <- as.character(annots$annot)
# str(annots) # [1] 12852     2


### Weevil Induce Q903 (Q903G - Q903W)
weevilInd_q903 <- (subset(sidf, sidf$focus_term == "weevilInd_Q903" & 
                            sidf$adj.P.Val <= pCutoff & abs(sidf$logFC) >= lfcCutoff))
# dim(weevilInd_q903) # [1] 5802    8


# Subset weevilInd_Q903 DE contigs from avgCPM
weevilInd_q903_avgCPM <- avgCPM[rownames(avgCPM) %in% weevilInd_q903$contig,]
# dim(weevilInd_q903_avgCPM) # [1] 5802    6


# Create cellnote when mouse hover over
weevilInd_q903_cellnote <- weevilInd_q903_avgCPM

for (i in 1:6) {
  weevilInd_q903_cellnote[, i] <- 
    paste("CPM : ", weevilInd_q903_cellnote[, i], "\n",
          "Annot : ", annots[rownames(weevilInd_q903_cellnote), "annot"])
}

weevilInd_q903_avgCPM_dist <- vegdist(weevilInd_q903_avgCPM, method = "horn")
weevilInd_q903_avgCPM_hclust <- hclust(weevilInd_q903_avgCPM_dist, "average")
weevilInd_q903_avgCPM_dendrogram <- as.dendrogram(weevilInd_q903_avgCPM_hclust)

weevilInd_q903_col_dist <- vegdist(t(weevilInd_q903_avgCPM), method = "horn")
weevilInd_q903_col_hclust <- hclust(weevilInd_q903_col_dist, "average")
weevilInd_q903_col_dendrogram <- as.dendrogram(weevilInd_q903_col_hclust)


d3heatmap(as.matrix(weevilInd_q903_avgCPM), 
                colors = heat.colors(50),
                scale = "row",
                Rowv = weevilInd_q903_avgCPM_dendrogram,
                Colv = weevilInd_q903_col_dendrogram,
                height = 8000,
                cellnote = weevilInd_q903_cellnote,
                anim_duration = 0)
```
